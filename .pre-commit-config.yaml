# test20
---
default_language_version:
  python: 3.10.0
  node: 17.1.0
repos:
  # frontend
  - repo: local
    hooks:
      - id: deno-fmt
        alias: frontend
        name: format js, ts, tsx, md, and json files with deno fmt
        language: system
        entry: direnv exec frontend just frontend/fmt-deno
        types_or: [javascript, ts, tsx, markdown, json]
        files: ^frontend/
        exclude: |
          (?x)^frontend/(
              .aleph|
              dist
          )/.*$
        pass_filenames: false
      - id: deno-lint
        alias: frontend
        name: check ts and tsx files with deno lint
        language: system
        entry: direnv exec frontend just frontend/lint-deno
        types_or: [ts, tsx]
        files: ^frontend/
        exclude: |
          (?x)^frontend/(
              .aleph|
              dist
          )/.*$
        pass_filenames: false
      - &stylelint
        id: stylelint
        alias: frontend
        name: format css files with stylelint
        language: system
        types: [css]
        files: ^frontend/
        exclude: |
          (?x)^frontend/(
              .aleph|
              dist
          )/.*$
        entry: direnv exec frontend just frontend/fmt-css-stylelint
        pass_filenames: false
      - name: check css files with stylelint
        entry: direnv exec frontend just frontend/lint-css
        <<: *stylelint
      - id: prettier
        alias: frontend
        name: format css file with prettier
        language: system
        entry: direnv exec frontend just frontend/fmt-css-prettier
        types: [css]
        pass_filenames: false
      - id: build-static-site
        alias: frontend
        name: check ts, tsx, and css files with aleph build
        language: system
        entry: direnv exec frontend just frontend/build-static-site
        types_or: [ts, tsx, css]
        files: ^frontend/
        exclude: |
          (?x)^frontend/(
              .aleph|
              dist|
              scripts
          )/.*$
        pass_filenames: false
      - id: lhci
        alias: frontend
        name: check with lhci
        language: system
        entry: direnv exec frontend just frontend/test
        types_or: [ts, tsx, css]
        files: ^frontend/
        exclude: |
          (?x)^frontend/(
              .aleph|
              dist|
              scripts
          )/.*$
        pass_filenames: false
  - repo: local
    hooks:
      - id: build-container-image
        alias: frontend
        name: check nginx.conf, project.toml, and buildpack.yml with skaffold
        language: system
        entry: sh -c 'mkdir frontend/dist/; just frontend/build-container-image'
        files: |
          (?x)^frontend/(
              nginx.conf|
              project.toml|
              buildpack.yml|
              skaffold.yaml
          )$
        pass_filenames: false
  # config
  - repo: local
    hooks:
      - id: yamllint
        alias: config
        name: check yaml file with yamllint
        entry: yamllint
        language: system
        types: [yaml]
      - &prettier
        id: prettier
        alias: config
        name: format yaml file with prettier
        language: system
        entry: just fmt-yaml
        types: [yaml]
      - id: skaffold
        alias: config
        name: check skaffold.yaml with skaffold diagnose
        language: system
        entry: sh -c 'cd frontend; mkdir dist/; skaffold diagnose'
        files: skaffold.yaml
  - repo: local
    hooks:
      - id: taplo-format
        alias: config
        name: format toml files with taplo format
        language: script
        entry: scripts/hooks/taplo-format.bash
        types: [toml]
      - id: taplo-lint
        alias: config
        name: check toml files with taplo lint
        language: system
        entry: just lint-toml
        types: [toml]
      - id: just
        alias: config
        name: format justfile with just --fmt option
        language: system
        entry: just --fmt --unstable
        files: justfile$
        pass_filenames: false
  # markup
  - repo: local
    hooks:
      - id: markdownlint
        alias: markup
        name: check markdown file with markdownlint
        entry: markdownlint
        language: system
        types: [markdown]
        exclude: ^infra/charts
      - id: markdownlint-fix
        alias: markup
        name: format markdown file with markdownlint
        entry: markdownlint --fix
        language: system
        types: [markdown]
        exclude: ^infra/charts
      - id: markdown-link-check
        alias: markup
        name: check link in markdown files with markdown-link-check
        language: script
        types: [markdown]
        entry: scripts/hooks/markdown-link-check.bash
  - repo: local
    hooks:
      - id: vale
        alias: markup
        name: check text files with vale
        language: system
        types: [markdown]
        entry: vale
        exclude: |
          (?x)^infra/(
              charts|
              terraform
          )
  # shell scripts
  - repo: local
    hooks:
      - &shfmt
        id: shfmt
        alias: shell-scripts
        name: format shell scripts with shfmt
        language: system
        entry: shfmt -w
        types: [shell]
      - name: format .envrc with shfmt
        files: .envrc$
        types: []
        <<: *shfmt
      - &shellharden
        id: shellharden
        alias: shell-scripts
        name: format shell scripts with shellharden
        language: system
        entry: direnv exec . shellharden --replace
        types: [shell]
      - name: format .envrc with shellharden
        files: .envrc$
        types: []
        <<: *shellharden
      - &shellcheck
        id: shellcheck
        alias: shell-scripts
        name: check shell scripts with shellcheck
        language: system
        entry: shellcheck
        types: [shell]
      - name: check .envrc with shellcheck
        entry: shellcheck -s bash
        files: .envrc$
        types: []
        <<: *shellcheck
  # vcs
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.0.1
    hooks:
      - id: check-added-large-files
        alias: vcs
      - id: check-case-conflict
        alias: vcs
      - id: check-merge-conflict
        alias: vcs
  - repo: local
    hooks:
      - id: commitlint
        alias: vcs
        name: check commit message with commitlint
        language: system
        stages: [commit-msg]
        entry: just lint-commit
      - id: gitleaks
        alias: vcs
        name: detect hardcoded secrets with gitleaks
        language: system
        entry: gitleaks protect --verbose --redact --staged
        pass_filenames: false
  # file
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.0.1
    hooks:
      - id: fix-byte-order-marker
        alias: file
  # text
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.0.1
    hooks:
      - id: trailing-whitespace
        alias: text
        exclude_types: [markdown]
      - id: end-of-file-fixer
        alias: text
        exclude: misc/diagram.svg$
  - repo: https://github.com/codespell-project/codespell
    rev: v2.1.0
    hooks:
      - id: codespell
        alias: text
        name: check common misspellings in text files with codespell
  # CI
  - repo: local
    hooks:
      - id: actionlint
        alias: ci
        name: check GitHub Actions workflow files with actionlint
        language: system
        entry: actionlint
        types: [yaml]
        files: "^.github/workflows/"
  # infra/charts
  - repo: local
    hooks:
      - id: kube-linter
        alias: infra/charts
        name: check helm chart with kube-linter
        language: system
        entry: kube-linter
        args:
          - lint
          - infra/charts/portfolio/
          - infra/charts/target-group-bindings/
        types: [yaml]
        files: ^infra/charts/
        pass_filenames: false
      - id: helm-docs
        alias: infra/charts
        name: generate document of helm chart with helm-docs
        language: system
        entry: helm-docs
        files: (README\.md\.gotmpl|(Chart|requirements|values)\.yaml)$
      - id: ct
        alias: infra/charts
        name: lint helm chart
        language: system
        entry: sh -c 'cd infra; ct lint --all'
        files: ^infra/charts
        pass_filenames: false
      - id: kubeval
        alias: infra/charts
        name: validate helm chart
        language: script
        entry: scripts/hooks/kubeval.bash
        files: ^infra/charts
        pass_filenames: false
      - id: checkov
        alias: infra/charts
        name: check helm charts with checkov
        language: script
        entry: scripts/hooks/checkov-helm-charts.bash
        files: ^infra/charts/
        pass_filenames: false
      - id: datree
        alias: infra/charts
        name: check helm charts with datree
        language: script
        entry: scripts/hooks/datree.bash
        files: ^infra/charts/
        pass_filenames: false
      - id: kube-score
        alias: infra/charts
        name: check helm charts with kube-score
        language: script
        entry: scripts/hooks/kube-score.bash
        files: ^infra/charts/
        pass_filenames: false
      - id: polaris
        alias: infra/charts
        name: check helm charts with polaris
        language: script
        entry: scripts/hooks/polaris.bash
        files: ^infra/charts/
        pass_filenames: false
      - id: pluto
        alias: infra/charts
        name: check helm charts with pluto
        language: script
        entry: scripts/hooks/pluto.bash
        files: ^infra/charts/
        pass_filenames: false
  # infra/terraform
  - repo: local
    hooks:
      - id: terraform-fmt
        alias: infra/terraform
        name: format terraform config
        language: system
        entry: terraform fmt -recursive infra/terraform/
        types: [terraform]
        pass_filenames: false
      - id: terraform-validate
        alias: infra/terraform
        name: validate terraform config
        language: script
        entry: scripts/hooks/terraform-validate.bash
        types: [terraform]
        pass_filenames: false
      - id: checkov
        alias: infra/terraform
        name: check terraform config with checkov
        language: system
        entry: checkov -d infra/terraform/
        types: [terraform]
        pass_filenames: false
      - id: terrascan
        alias: infra/terraform
        name: check terraform config with terrascan
        language: system
        entry: >-
          sh -c '
            find infra/terraform/modules/ -mindepth 1 -maxdepth 1 -type d |
            xargs -t -I {} terrascan scan -d {} -i terraform -v
          '
        types: [terraform]
        pass_filenames: false
      - id: trivy
        alias: infra/terraform
        name: check terraform config with trivy
        language: system
        entry: sh -c 'cd infra/terraform/; trivy conf .; cd - >/dev/null'
        types: [terraform]
        pass_filenames: false
      - id: tflint
        alias: infra/terraform
        name: check terraform config with tflint
        language: system
        entry: >-
          sh -c '
            cd infra/terraform/
            (
              set -x
              tflint --init
              tflint
            )
            cd - >/dev/null
          '
        types: [terraform]
        pass_filenames: false
      - id: terraform-docs
        alias: infra/terraform
        name: generate document of terraform modules with terraform-docs
        language: system
        entry: terraform-docs infra/terraform/
        types: [terraform]
        pass_filenames: false
  # infra/terragrunt
  - repo: local
    hooks:
      - id: terragrunt-hclfmt
        alias: infra/terragrunt
        name: format terragrunt config
        language: system
        entry: >-
          sh -c '
            cd infra/terragrunt/
            terragrunt hclfmt
            cd - >/dev/null
          '
        files: ^infra/terragrunt/
        pass_filenames: false
  # infra/flux
  - repo: local
    hooks:
      - id: kubeconform
        alias: infra/flux
        name: check manifest files with kubeconform
        language: script
        entry: infra/flux/scripts/kubeconform.bash
        files: ^infra/flux/
        pass_filenames: false
